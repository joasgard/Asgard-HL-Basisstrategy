<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Delta Neutral Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .leverage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        .leverage-slider {
            -webkit-appearance: none;
            height: 8px;
            background: #374151;
            border-radius: 4px;
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Security Banner -->
    <div class="bg-yellow-900/50 border-b border-yellow-700 px-4 py-2">
        <div class="max-w-7xl mx-auto flex items-center gap-2 text-yellow-200 text-sm">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
            <span><strong>Security Notice:</strong> Your data is encrypted. Wallets are managed by Privy.</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold">Delta Neutral Bot</h1>
                <p class="text-gray-400 text-sm">Asgard + Hyperliquid Funding Rate Arbitrage</p>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-400">Bot: <span class="text-yellow-400">{{ bot_status }}</span></span>
                <form action="/setup/logout" method="post">
                    <button type="submit" class="text-sm text-gray-400 hover:text-white">Logout</button>
                </form>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="border-b border-gray-700 mb-6">
            <div class="flex gap-8">
                <button onclick="switchTab('home')" id="tab-home" class="tab-active pb-3 px-2 font-medium transition-colors">
                    üè† Home
                </button>
                <button onclick="switchTab('settings')" id="tab-settings" class="pb-3 px-2 text-gray-400 hover:text-white font-medium transition-colors">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </div>

        <!-- HOME TAB -->
        <div id="content-home" class="space-y-6">
            <!-- Leverage Selector -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium">Desired Leverage</h2>
                    <span id="leverage-display" class="text-3xl font-bold text-blue-400">3.0x</span>
                </div>
                <input 
                    type="range" 
                    id="leverage-slider"
                    min="2" 
                    max="4" 
                    step="0.1" 
                    value="3.0"
                    class="leverage-slider w-full"
                    oninput="updateLeverage(this.value)"
                >
                <div class="flex justify-between text-sm text-gray-500 mt-2">
                    <span>2x (Conservative)</span>
                    <span>3x (Balanced)</span>
                    <span>4x (Aggressive)</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <!-- LEFT COLUMN: Strategy Performance + Quick Stats -->
                <div class="space-y-6">
                    <!-- Strategy Performance -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-medium">üéØ Strategy Performance</h2>
                            <span class="text-xs text-gray-500">Net APY @ <span id="perf-leverage">3.0</span>x</span>
                        </div>
                        
                        <!-- Net APY Display -->
                        <div class="p-6 bg-gradient-to-r from-blue-900/50 to-purple-900/50 border border-blue-700/50 rounded-xl text-center">
                            <div class="text-sm text-blue-300 mb-2">Net APY</div>
                            <div class="text-5xl font-bold text-white mb-2" id="net-apy">--</div>
                            <div class="text-sm text-gray-400">via <span id="net-apy-protocol">--</span> Protocol</div>
                        </div>
                        
                        <!-- Breakdown -->
                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-gray-900/30 rounded-lg p-3 text-center">
                                <div class="text-gray-400 text-xs">Long Leg (Asgard)</div>
                                <div class="font-mono text-lg text-green-400" id="breakdown-long">--</div>
                            </div>
                            <div class="bg-gray-900/30 rounded-lg p-3 text-center">
                                <div class="text-gray-400 text-xs">Short Leg (Hyperliquid)</div>
                                <div class="font-mono text-lg text-green-400" id="breakdown-short">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-lg font-medium mb-4">üìä Quick Stats</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Open Positions</span>
                                <span class="font-mono">{{ positions_count }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">24h PnL</span>
                                <span class="font-mono {{ 'text-green-400' if pnl_24h > 0 else 'text-red-400' if pnl_24h < 0 else '' }}">{{ pnl_24h }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Total Value</span>
                                <span class="font-mono">${{ total_value }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Start Trading Button -->
                    <button 
                        onclick="openPositionModal()"
                        class="w-full py-4 bg-green-600 hover:bg-green-700 rounded-xl font-bold text-lg transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Open Position
                    </button>
                </div>

                <!-- RIGHT COLUMN: Leg Details (Stacked) -->
                <div class="space-y-6">
                    <!-- Asgard Leg Details (Top) -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-medium">üèõÔ∏è Asgard Leg</h2>
                            <div class="text-right">
                                <div class="text-xs text-gray-400">Asgard APY</div>
                                <div id="asgard-total-apy" class="text-lg font-bold text-emerald-400">--</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div>
                                    <div class="text-sm text-gray-300">SOL Supply Rate</div>
                                    <div class="text-xs text-gray-500">Long exposure scaled √ó leverage</div>
                                </div>
                                <div id="asgard-lending-apy" class="text-lg font-medium text-emerald-400">--</div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div>
                                    <div class="text-sm text-gray-300">USDC Borrow Rate</div>
                                    <div class="text-xs text-gray-500">Cost scaled √ó (leverage - 1)</div>
                                </div>
                                <div id="asgard-borrowing-apy" class="text-lg font-medium text-rose-400">--</div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-blue-900/30 rounded-lg">
                            <div class="text-xs text-blue-300 mb-1">Formula</div>
                            <div class="text-sm text-blue-200 font-mono">(Lending √ó L) - (Borrowing √ó (L-1))</div>
                        </div>
                    </div>

                    <!-- Hyperliquid Leg Details (Bottom) -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-medium">‚ö° Hyperliquid Leg</h2>
                            <div class="text-right">
                                <div class="text-xs text-gray-400">HL APY</div>
                                <div id="hl-total-apy" class="text-lg font-bold text-emerald-400">--</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div>
                                    <div class="text-sm text-gray-300">SOL-PERP Funding</div>
                                    <div class="text-xs text-gray-500">Hourly rate √ó 24 √ó 365 √ó leverage</div>
                                </div>
                                <div id="hl-funding-rate" class="text-lg font-medium">--</div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div>
                                    <div class="text-sm text-gray-300">Annualized Rate</div>
                                    <div class="text-xs text-gray-500">Effective APY from funding</div>
                                </div>
                                <div id="hl-annualized" class="text-lg font-medium text-emerald-400">--</div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-purple-900/30 rounded-lg">
                            <div class="text-xs text-purple-300 mb-1">Short Position</div>
                            <div class="text-sm text-purple-200">Negative funding = shorts get paid ‚úì</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Positions -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h2 class="text-lg font-medium mb-4">Active Positions</h2>
                <div id="positions-list">
                    {% if positions %}
                        <div class="space-y-3">
                            {% for pos in positions %}
                            <div class="bg-gray-900/50 rounded-lg p-4 flex items-center justify-between">
                                <div>
                                    <span class="font-medium">{{ pos.asset }}</span>
                                    <span class="text-sm text-gray-400">@ {{ pos.leverage }}x</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono">${{ pos.size }}</div>
                                    <div class="text-sm {{ 'text-green-400' if pos.pnl > 0 else 'text-red-400' }}">{{ pos.pnl }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p>No active positions</p>
                            <p class="text-sm mt-1">Select leverage and click "Open Position" to start</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        <!-- SETTINGS TAB -->
        <div id="content-settings" class="space-y-6 hidden">
            <!-- Preset Selector -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h2 class="text-lg font-medium mb-4">Strategy Presets</h2>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <button onclick="loadPreset(1)" class="preset-btn p-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors" data-preset="1">
                        <div class="font-medium">Preset 1</div>
                        <div class="text-sm text-gray-400 preset-desc" id="preset-1-desc">Not saved</div>
                    </button>
                    <button onclick="loadPreset(2)" class="preset-btn p-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors" data-preset="2">
                        <div class="font-medium">Preset 2</div>
                        <div class="text-sm text-gray-400 preset-desc" id="preset-2-desc">Not saved</div>
                    </button>
                    <button onclick="loadPreset(3)" class="preset-btn p-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-left transition-colors" data-preset="3">
                        <div class="font-medium">Preset 3</div>
                        <div class="text-sm text-gray-400 preset-desc" id="preset-3-desc">Not saved</div>
                    </button>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveCurrentPreset()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                        üíæ Save to Selected Preset
                    </button>
                    <button onclick="resetDefaults()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                        üîÑ Reset to Defaults
                    </button>
                </div>
            </div>

            <!-- Strategy Settings Form -->
            <form id="settings-form" class="space-y-6">
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h2 class="text-lg font-medium mb-4">Position Settings</h2>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Default Leverage</label>
                            <input 
                                type="number" 
                                name="default_leverage"
                                id="setting-leverage"
                                min="2" 
                                max="4" 
                                step="0.1"
                                value="3.0"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Max Position Size (USD)</label>
                            <input 
                                type="number" 
                                name="max_position_size"
                                id="setting-max-position"
                                min="1000"
                                step="1000"
                                value="50000"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Min Position Size (USD)</label>
                            <input 
                                type="number" 
                                name="min_position_size"
                                id="setting-min-position"
                                min="100"
                                step="100"
                                value="1000"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Max Positions per Asset</label>
                            <input 
                                type="number" 
                                name="max_positions_per_asset"
                                id="setting-max-per-asset"
                                min="1"
                                max="5"
                                value="1"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h2 class="text-lg font-medium mb-4">Entry Criteria</h2>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Min Opportunity APY (%)</label>
                            <input 
                                type="number" 
                                name="min_opportunity_apy"
                                id="setting-min-apy"
                                min="0"
                                max="100"
                                step="0.1"
                                value="1.0"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Max Funding Volatility (%)</label>
                            <input 
                                type="number" 
                                name="max_funding_volatility"
                                id="setting-max-volatility"
                                min="0"
                                max="100"
                                step="1"
                                value="50"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h2 class="text-lg font-medium mb-4">Risk Management</h2>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Price Deviation Threshold (%)</label>
                            <input 
                                type="number" 
                                name="price_deviation_threshold"
                                id="setting-price-dev"
                                min="0.1"
                                max="5"
                                step="0.1"
                                value="0.5"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Delta Drift Threshold (%)</label>
                            <input 
                                type="number" 
                                name="delta_drift_threshold"
                                id="setting-delta-drift"
                                min="0.1"
                                max="5"
                                step="0.1"
                                value="0.5"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                            >
                        </div>
                    </div>

                    <div class="mt-4 flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                name="enable_auto_exit"
                                id="setting-auto-exit"
                                checked
                                class="w-4 h-4 rounded bg-gray-700 border-gray-600"
                            >
                            <span class="text-sm">Enable Auto-Exit</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                name="enable_circuit_breakers"
                                id="setting-circuit-breakers"
                                checked
                                class="w-4 h-4 rounded bg-gray-700 border-gray-600"
                            >
                            <span class="text-sm">Enable Circuit Breakers</span>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="resetDefaults()" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg">
                        Reset Defaults
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Open Position Modal -->
    <div id="position-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 border border-gray-700">
            <h2 class="text-xl font-bold mb-4">Confirm Position</h2>
            <div class="space-y-3 mb-6">
                <div class="flex justify-between">
                    <span class="text-gray-400">Leverage</span>
                    <span class="font-mono" id="modal-leverage">3.0x</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Asset</span>
                    <select id="modal-asset" class="bg-gray-700 border border-gray-600 rounded px-2 py-1">
                        <option value="SOL">SOL</option>
                        <option value="jitoSOL">jitoSOL</option>
                        <option value="jupSOL">jupSOL</option>
                        <option value="INF">INF</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Size (USD)</span>
                    <input 
                        type="number" 
                        id="modal-size"
                        value="10000"
                        min="1000"
                        step="1000"
                        class="bg-gray-700 border border-gray-600 rounded px-2 py-1 w-32 text-right"
                    >
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closePositionModal()" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
                <button onclick="submitPosition()" class="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium">Open Position</button>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tab) {
            document.getElementById('content-home').classList.add('hidden');
            document.getElementById('content-settings').classList.add('hidden');
            document.getElementById('tab-home').classList.remove('tab-active');
            document.getElementById('tab-home').classList.add('text-gray-400');
            document.getElementById('tab-settings').classList.remove('tab-active');
            document.getElementById('tab-settings').classList.add('text-gray-400');
            
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active');
            document.getElementById('tab-' + tab).classList.remove('text-gray-400');
        }

        // Leverage handling
        let currentLeverage = 3.0;
        
        function updateLeverage(value) {
            currentLeverage = parseFloat(value);
            document.getElementById('leverage-display').textContent = currentLeverage.toFixed(1) + 'x';
            document.getElementById('hl-leverage').textContent = currentLeverage.toFixed(1);
            
            // Update settings form to match
            document.getElementById('setting-leverage').value = currentLeverage;
            
            // Fetch updated rates
            fetchRates(currentLeverage);
        }

        // Fetch rates from API
        async function fetchRates(leverage) {
            try {
                const response = await fetch(`/api/v1/rates?leverage=${leverage}`);
                const data = await response.json();
                
                const venues = data.asgard || {};
                const combined = data.combined || {};
                
                // Find best NET APY
                let bestNetApy = -Infinity;
                let bestProtocol = '';
                for (const [protocol, apy] of Object.entries(combined)) {
                    if (apy > bestNetApy) {
                        bestNetApy = apy;
                        bestProtocol = protocol;
                    }
                }
                
                // Update Net APY display
                const netApyEl = document.getElementById('net-apy');
                const netApyProtocolEl = document.getElementById('net-apy-protocol');
                if (netApyEl && bestProtocol) {
                    netApyEl.textContent = (bestNetApy >= 0 ? '+' : '') + bestNetApy.toFixed(2) + '%';
                    netApyEl.className = 'text-5xl font-bold ' + (bestNetApy >= 0 ? 'text-green-400' : 'text-red-400');
                    netApyProtocolEl.textContent = bestProtocol.charAt(0).toUpperCase() + bestProtocol.slice(1);
                }
                
                // Update breakdown section
                const asgardApy = bestProtocol ? (venues[bestProtocol] || 0) : 0;
                const hlAnnualized = data.hyperliquid?.annualized || 0;
                const shortApy = -hlAnnualized; // Negative funding is good for shorts
                
                const breakdownLong = document.getElementById('breakdown-long');
                const breakdownShort = document.getElementById('breakdown-short');
                if (breakdownLong) {
                    breakdownLong.textContent = (asgardApy >= 0 ? '+' : '') + asgardApy.toFixed(2) + '%';
                    breakdownLong.className = 'font-mono text-lg ' + (asgardApy >= 0 ? 'text-green-400' : 'text-red-400');
                }
                if (breakdownShort) {
                    breakdownShort.textContent = (shortApy >= 0 ? '+' : '') + shortApy.toFixed(2) + '%';
                    breakdownShort.className = 'font-mono text-lg ' + (shortApy >= 0 ? 'text-green-400' : 'text-red-400');
                }
                
                // Update Asgard Leg Details
                if (data.asgard_details) {
                    const lendingEl = document.getElementById('asgard-lending-apy');
                    const borrowingEl = document.getElementById('asgard-borrowing-apy');
                    const totalEl = document.getElementById('asgard-total-apy');
                    
                    if (lendingEl) lendingEl.textContent = '+' + data.asgard_details.lending_apy.toFixed(2) + '%';
                    if (borrowingEl) borrowingEl.textContent = '-' + data.asgard_details.borrowing_apy.toFixed(2) + '%';
                    if (totalEl) {
                        const asgardTotal = data.asgard_details.net_apy;
                        totalEl.textContent = (asgardTotal >= 0 ? '+' : '') + asgardTotal.toFixed(2) + '%';
                        totalEl.className = 'text-lg font-bold ' + (asgardTotal >= 0 ? 'text-emerald-400' : 'text-rose-400');
                    }
                }
                
                // Update Hyperliquid Leg Details
                const funding = data.hyperliquid?.funding_rate || 0;
                const annualized = data.hyperliquid?.annualized || 0;
                
                const hlFundingEl = document.getElementById('hl-funding-rate');
                const hlAnnualEl = document.getElementById('hl-annualized');
                const hlTotalEl = document.getElementById('hl-total-apy');
                
                if (hlFundingEl) hlFundingEl.textContent = funding.toFixed(4) + '%';
                if (hlAnnualEl) hlAnnualEl.textContent = (annualized >= 0 ? '+' : '') + annualized.toFixed(2) + '%';
                if (hlTotalEl) {
                    const shortApyTotal = -annualized;
                    hlTotalEl.textContent = (shortApyTotal >= 0 ? '+' : '') + shortApyTotal.toFixed(2) + '%';
                    hlTotalEl.className = 'text-lg font-bold ' + (shortApyTotal >= 0 ? 'text-emerald-400' : 'text-rose-400');
                }
            } catch (e) {
                console.error('Failed to fetch rates:', e);
            }
        }

        // Position modal
        function openPositionModal() {
            document.getElementById('modal-leverage').textContent = currentLeverage.toFixed(1) + 'x';
            document.getElementById('position-modal').classList.remove('hidden');
            document.getElementById('position-modal').classList.add('flex');
        }

        function closePositionModal() {
            document.getElementById('position-modal').classList.add('hidden');
            document.getElementById('position-modal').classList.remove('flex');
        }

        async function submitPosition() {
            const asset = document.getElementById('modal-asset').value;
            const size = document.getElementById('modal-size').value;
            
            try {
                const response = await fetch('/api/v1/positions/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        asset: asset,
                        leverage: currentLeverage,
                        size_usd: parseFloat(size)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    closePositionModal();
                    // Show job status and start polling
                    showJobStatus(result.job_id);
                } else {
                    alert('Failed to open position: ' + (result.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Job status polling
        let jobPollInterval;
        
        function showJobStatus(jobId) {
            const modal = document.getElementById('position-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 border border-gray-700">
                    <h2 class="text-xl font-bold mb-4">Opening Position...</h2>
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center gap-3">
                            <div id="job-spinner" class="animate-spin h-5 w-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                            <span id="job-status">Initializing...</span>
                        </div>
                        <div class="text-sm text-gray-400">Job ID: ${jobId}</div>
                    </div>
                    <button onclick="closePositionModal()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Close</button>
                </div>
            `;
            
            // Start polling
            pollJobStatus(jobId);
            jobPollInterval = setInterval(() => pollJobStatus(jobId), 2000);
        }
        
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/v1/positions/jobs/${jobId}`);
                const job = await response.json();
                
                const statusEl = document.getElementById('job-status');
                const spinnerEl = document.getElementById('job-spinner');
                
                if (!statusEl) return; // Modal closed
                
                statusEl.textContent = getStatusMessage(job.status, job.error_stage);
                
                if (job.status === 'completed') {
                    clearInterval(jobPollInterval);
                    spinnerEl.classList.remove('animate-spin');
                    spinnerEl.classList.add('bg-green-500', 'rounded-full');
                    spinnerEl.innerHTML = '‚úì';
                    
                    setTimeout(() => {
                        closePositionModal();
                        location.reload(); // Refresh to show new position
                    }, 1500);
                } else if (job.status === 'failed') {
                    clearInterval(jobPollInterval);
                    spinnerEl.classList.remove('animate-spin');
                    spinnerEl.classList.add('bg-red-500', 'rounded-full');
                    spinnerEl.innerHTML = '‚úó';
                    
                    statusEl.innerHTML = `<span class="text-red-400">Failed: ${job.error || 'Unknown error'}</span>`;
                }
            } catch (e) {
                console.error('Failed to poll job status:', e);
            }
        }
        
        function getStatusMessage(status, stage) {
            const messages = {
                'pending': 'Waiting to start...',
                'running': {
                    'market_data': 'Fetching market data...',
                    'preflight': 'Running preflight checks...',
                    'asgard_open': 'Opening Asgard position...',
                    'hyperliquid_open': 'Opening Hyperliquid position...',
                    'validation': 'Validating position...',
                    'unknown': 'Processing...'
                },
                'completed': 'Position opened successfully!',
                'failed': 'Failed'
            };
            
            if (status === 'running' && stage) {
                return messages.running[stage] || messages.running.unknown;
            }
            return messages[status] || status;
        }

        // Settings and Presets
        const DEFAULTS = {
            default_leverage: 3.0,
            max_position_size: 50000,
            min_position_size: 1000,
            max_positions_per_asset: 1,
            min_opportunity_apy: 1.0,
            max_funding_volatility: 50,
            price_deviation_threshold: 0.5,
            delta_drift_threshold: 0.5,
            enable_auto_exit: true,
            enable_circuit_breakers: true
        };

        let selectedPreset = 1;

        function loadPreset(num) {
            selectedPreset = num;
            
            // Update UI
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            document.querySelector(`[data-preset="${num}"]`).classList.add('ring-2', 'ring-blue-500');
            
            // Load from localStorage
            const saved = localStorage.getItem(`preset-${num}`);
            if (saved) {
                const config = JSON.parse(saved);
                applySettings(config);
            }
        }

        function saveCurrentPreset() {
            const config = collectSettings();
            localStorage.setItem(`preset-${selectedPreset}`, JSON.stringify(config));
            
            // Update description
            const desc = `Leverage: ${config.default_leverage}x, Max: $${config.max_position_size}`;
            document.getElementById(`preset-${selectedPreset}-desc`).textContent = desc;
            
            alert(`Saved to Preset ${selectedPreset}`);
        }

        function resetDefaults() {
            applySettings(DEFAULTS);
        }

        function collectSettings() {
            return {
                default_leverage: parseFloat(document.getElementById('setting-leverage').value),
                max_position_size: parseInt(document.getElementById('setting-max-position').value),
                min_position_size: parseInt(document.getElementById('setting-min-position').value),
                max_positions_per_asset: parseInt(document.getElementById('setting-max-per-asset').value),
                min_opportunity_apy: parseFloat(document.getElementById('setting-min-apy').value),
                max_funding_volatility: parseInt(document.getElementById('setting-max-volatility').value),
                price_deviation_threshold: parseFloat(document.getElementById('setting-price-dev').value),
                delta_drift_threshold: parseFloat(document.getElementById('setting-delta-drift').value),
                enable_auto_exit: document.getElementById('setting-auto-exit').checked,
                enable_circuit_breakers: document.getElementById('setting-circuit-breakers').checked
            };
        }

        function applySettings(config) {
            document.getElementById('setting-leverage').value = config.default_leverage;
            document.getElementById('setting-max-position').value = config.max_position_size;
            document.getElementById('setting-min-position').value = config.min_position_size;
            document.getElementById('setting-max-per-asset').value = config.max_positions_per_asset;
            document.getElementById('setting-min-apy').value = config.min_opportunity_apy;
            document.getElementById('setting-max-volatility').value = config.max_funding_volatility;
            document.getElementById('setting-price-dev').value = config.price_deviation_threshold;
            document.getElementById('setting-delta-drift').value = config.delta_drift_threshold;
            document.getElementById('setting-auto-exit').checked = config.enable_auto_exit;
            document.getElementById('setting-circuit-breakers').checked = config.enable_circuit_breakers;
            
            // Update leverage slider to match
            currentLeverage = config.default_leverage;
            document.getElementById('leverage-slider').value = currentLeverage;
            document.getElementById('leverage-display').textContent = currentLeverage.toFixed(1) + 'x';
        }

        // Form submission
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const config = collectSettings();
            
            try {
                const response = await fetch('/api/v1/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    alert('Settings saved successfully');
                } else {
                    alert('Failed to save settings');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        });

        // Load presets on page load
        window.addEventListener('load', () => {
            for (let i = 1; i <= 3; i++) {
                const saved = localStorage.getItem(`preset-${i}`);
                if (saved) {
                    const config = JSON.parse(saved);
                    const desc = `Leverage: ${config.default_leverage}x, Max: $${config.max_position_size}`;
                    document.getElementById(`preset-${i}-desc`).textContent = desc;
                }
            }
            loadPreset(1);
            
            // Initial rates fetch
            fetchRates(currentLeverage);
        });
    </script>
</body>
</html>
